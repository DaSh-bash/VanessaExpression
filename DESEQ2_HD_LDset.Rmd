---
title: "*Vanessa cardui* DE"
output: html_notebook
---

# Differntial expression in *Vanessa cardui* adults
Experimental set up was prepared with adult females in two food availability conditions: ad libitum and no resources plus low and high density, to analyze the influence that environmental conditions may have on investment in migration or reproduction in imagines


**Preparing data**
We upload count data from the DESeq2 object crated within the nf-core rnasq pipeline. Pipeline was run for the entire experimental dataset therefore needs to be split into different sets/tissues:

```{r}
load("/Users/dshipilina/GitHub/VanessaExpression/deseq2_qc/deseq2.dds.RData") #loading file
countLR<- dds@assays@data@listData[["counts"]] #reloading count data
colDataLR <- colData(dds) #reloading metadata 

#Renaming columns for clarity
names(colDataLR)[names(colDataLR)=="Group3"]<-"tissue"
names(colDataLR)[names(colDataLR)=="Group1"]<-"condition"

#Checking resulting tables
head(countLR)
head(colDataLR)
```

Pipeline was run for the entire experimental dataset therefore needs to be split into different sets/tissues:

```{r}
colDataLRab<-colDataLR[colDataLR$tissue == "A", ] #selecting abdomen samples only
#selecting samples with abdomen tissue based on ID 
countLRab<-countLR[,c(1,2,3,4,5,10,11,12,13,14)]
names(colDataLRab)[names(colDataLRab)=="Group3"]<-"tissue"
names(colDataLRab)[names(colDataLRab)=="Group1"]<-"condition"

head(countLR)
head(colDataLR)
```


Constructing DESeq2 object, at this point counts are transformed according to the DESeq specific algorithm.
Current hypothsis includes split into treatment groups *only* (~condition), filtering out genes with less then 10 total counts 
```{r}
ddsLRab <- DESeqDataSetFromMatrix(countData=countLRab, colData =colDataLRab, design = ~condition)

#Basic filtering
keep <- rowSums(counts(ddsLRab)) >= 10
ddsLRab <- ddsLRab[keep,]
head(ddsLRab)
```


**DESeq analysis**
Main valuation, calculation of p-values
```{r}
#ddsLRab <- DESeq(ddsLRab) #running the main function
resLRab <- results(ddsLRab)
resLRab <- resLRab[order(resLRab$padj),]
head(resLRab)
summary(resLRab)
```

Setting up p-value to 0.05
```{r}
res05 <- results(ddsLRab, alpha=0.05)
summary(res05)
```



Log fold change shrinkage is recommended for visualization and ranking, her we follow main DESEq2 vignette exactly

"Shrinkage of effect size (LFC estimates) is useful for visualization and ranking of genes. To shrink the LFC, we pass the dds object to the function lfcShrink. Below we specify to use the apeglm method for effect size shrinkage (Zhu, Ibrahim, and Love 2018), which improves on the previous estimator.

We provide the dds object and the name or number of the coefficient we want to shrink, where the number refers to the order of the coefficient as it appears in resultsNames(dds)."


```{r}
head(resultsNames(ddsLRab))
resLFC <- lfcShrink(ddsLRab, coef="condition_LI_vs_AL", type="apeglm")
resLFC
```


Visual exploration of the results

We us first 100 significant genes to build a PCA plot:
```{r}
vsdata <- vst(ddsLRab, blind=FALSE)
plotPCA(vsdata, intgroup=c("condition"))
```

We use function plotMA, that shows the log2 fold changes attributable to a given variable over the mean of normalized counts for all the samples in the DESeqDataSet. Points are colored blue if the adjusted p-value is less than 0.1.
```{r}
plotMA(resLRab, ylim=c(-5,5))
```

Checking significant gene candidates:
```{r}
res <- resLRab[order(resLRab$padj),]
head(res, 10)

#Plotting these genes
plotCounts(ddsLRab, gene="Vcard_DToL13592", intgroup="condition")
plotCounts(ddsLRab, gene="Vcard_DToL04829", intgroup="condition")
plotCounts(ddsLRab, gene="Vcard_DToL13539", intgroup="condition")
plotCounts(ddsLRab, gene="Vcard_DToL02600", intgroup="condition")
plotCounts(ddsLRab, gene="Vcard_DToL10357", intgroup="condition")
plotCounts(ddsLRab, gene="Vcard_DToL13220", intgroup="condition")
plotCounts(ddsLRab, gene="Vcard_DToL16018", intgroup="condition")
```

Checking functions of the differentialy expressed genes

```{bash}
#ls
grep "Vcard_DToL13592" vcard.func.annot.csv | awk -F "," '{print $1,$15,$16}'
grep "Vcard_DToL04829" vcard.func.annot.csv | awk -F "," '{print $1,$14,$15}'
grep "Vcard_DToL13539" vcard.func.annot.csv | awk -F "," '{print $1,$15,$16}'
grep "Vcard_DToL02600" vcard.func.annot.csv | awk -F "," '{print $1,$15,$16}'
grep "Vcard_DToL10357" vcard.func.annot.csv | awk -F "," '{print $1,$15,$16}'
grep "Vcard_DToL13220" vcard.func.annot.csv | awk -F "," '{print $1,$15,$16}'
grep "Vcard_DToL16018" vcard.func.annot.csv | awk -F "," '{print $1,$15,$16}'
```


```{bash}
grep "Vcard_DToL13592" vcard.func.annot.csv 
grep "Vcard_DToL04829" vcard.func.annot.csv 
grep "Vcard_DToL13539" vcard.func.annot.csv 
grep "Vcard_DToL02600" vcard.func.annot.csv 
grep "Vcard_DToL10357" vcard.func.annot.csv 
grep "Vcard_DToL13220" vcard.func.annot.csv 
grep "Vcard_DToL16018" vcard.func.annot.csv 

```



```{r}
tab <- matrix(c("N/A", "N/A", "Isl-1", "Insulin gene enhancer protein, gene encodes a transcription factor containing two N-terminal LIM domains and one C-terminal homeodomain","A10/OS-D","Insect pheromone-binding family","glipr2",1,1,1,1,1,1,1), ncol=2, byrow=TRUE)
colnames(tab) <- c('GeneName','Function')
rownames(tab) <- c('Vcard_DToL13592',"Vcard_DToL04829","Vcard_DToL13539","Vcard_DToL02600","Vcard_DToL10357","Vcard_DToL13220","Vcard_DToL16018" )
tab <- as.table(tab)

tab

```



